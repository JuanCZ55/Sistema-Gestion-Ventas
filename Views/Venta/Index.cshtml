@model IEnumerable<SistemaGestionVentas.Models.Venta>
@using System.Security.Claims
@{
  ViewData["Title"] = "Ventas";
  int total = ViewBag?.Total ?? 0;
  int pageSize = ViewBag?.PageSize ?? 10;
  int totalPages = total > 0 ? (int)Math.Ceiling((double)total / pageSize) : 1;
  int currentPage = ViewBag?.Page ?? 1;
  int? metodoPagoIdFiltro = ViewBag?.MetodoPagoIdFiltro;
  DateTime? fechaMin = ViewBag?.FechaMin;
  DateTime? fechaMax = ViewBag?.FechaMax;
  bool? estadoFiltro = ViewBag?.EstadoFiltro;
  int? usuarioCreadorIdFiltro = ViewBag?.UsuarioCreadorIdFiltro;
  int? usuarioModificadorIdFiltro = ViewBag?.UsuarioModificadorIdFiltro;
  var isAdmin = User.FindFirst(ClaimTypes.Role)?.Value == "1";
}

<!-- Formulario de filtros -->
<form method="get" asp-action="Index" class="mb-3">
  <div class="row g-2">
    <div class="col-md-2">
      <label class="invisible">Crear</label>
      <a asp-action="Create" class="btn btn-primary w-100">Crear Nueva</a>
    </div>
    <div class="col-md-2">
      <label for="metodoPagoId">Método de Pago</label>
      <select class="form-select" id="metodoPagoId" name="metodoPagoId">
        <option value="">Todos</option>
        @foreach (var item in (IEnumerable<SelectListItem>)ViewData["MetodoPagoId"]!)
        {
          <option value="@item.Value" selected="@(item.Value == metodoPagoIdFiltro?.ToString())">@item.Text</option>
        }
      </select>
    </div>
    <div class="col-md-2">
      <label for="fechaMin">Fecha desde</label>
      <input type="date" class="form-control" id="fechaMin" name="fechaMin" 
             value="@fechaMin?.ToString("yyyy-MM-dd")">
    </div>
    <div class="col-md-2">
      <label for="fechaMax">Fecha hasta</label>
      <input type="date" class="form-control" id="fechaMax" name="fechaMax" 
             value="@fechaMax?.ToString("yyyy-MM-dd")">
    </div>
    <div class="col-md-2">
      <label for="estado">Estado</label>
      <select class="form-select" id="estado" name="estado">
        <option value="" selected="@(estadoFiltro == null)">Todos</option>
        <option value="true" selected="@(estadoFiltro == true)">Activa</option>
        <option value="false" selected="@(estadoFiltro == false)">Anulada</option>
      </select>
    </div>
    <div class="col-md-2">
      <label>&nbsp;</label>
      <button type="submit" class="btn btn-success w-100">Filtrar</button>
    </div>
  </div>
  @if (isAdmin)
  {
    <div class="row g-2 mt-1">
      <div class="col-md-2">
        <!-- Espaciador -->
      </div>
      <div class="col-md-3">
        <label for="usuarioCreadorId">Usuario Creador</label>
        <select class="form-select text-capitalize" id="usuarioCreadorId" name="usuarioCreadorId">
          <option value="">Todos</option>
          @foreach (var item in (IEnumerable<SelectListItem>)ViewData["UsuarioCreadorId"]!)
          {
            <option value="@item.Value" selected="@(item.Value == usuarioCreadorIdFiltro?.ToString())">@item.Text</option>
          }
        </select>
      </div>
      <div class="col-md-3">
        <label for="usuarioModificadorId">Usuario Modificador</label>
        <select class="form-select text-capitalize" id="usuarioModificadorId" name="usuarioModificadorId">
          <option value="">Todos</option>
          @foreach (var item in (IEnumerable<SelectListItem>)ViewData["UsuarioModificadorId"]!)
          {
            <option value="@item.Value" selected="@(item.Value == usuarioModificadorIdFiltro?.ToString())">@item.Text</option>
          }
        </select>
      </div>
    </div>
  }
</form>

<table class="table">
  <thead>
    <tr>
      <th>
        Fecha
      </th>
      <th>
        Detalle
      </th>
      <th>
        Total
      </th>
      <th>
        Método de Pago
      </th>
      @if (isAdmin)
      {
        <th>
          Usuario Creador
        </th>
        <th>
          Usuario Modificador
        </th>
      }
      <th>
        Estado
      </th>
      <th>
        Acciones
      </th>
    </tr>
  </thead>
  <tbody>
    @foreach (var item in Model)
    {
      <tr>
        <td>
          @item.Fecha.ToLocalTime().ToString("dd/MM/yyyy HH:mm")
        </td>
        <td class="text-capitalize">
          @if (item.Detalles.Any())
          {
            var first = item.Detalles.First();
            <span data-bs-toggle="tooltip" data-bs-html="true"
                  data-bs-title="@string.Join("<br>", item.Detalles.Select(d => d.Producto?.Nombre + " x" + d.Cantidad))">@(first.Producto?.Nombre)
              x@(first.Cantidad)</span>
            }
          else
            {
              <span>N/A</span>
            }
          </td>
          <td>
            $@item.Total.ToString("N2")
          </td>
          <td class="text-capitalize">
            @if (item.MetodoPago != null)
            {
              @Html.DisplayFor(modelItem => item!.MetodoPago!.Nombre)
            }
            else
            {
              <span>N/A</span>
            }
          </td>
          @if (isAdmin)
          {
            <td class="text-capitalize">
              @if (item.UsuarioCreador != null)
              {
                @($"{item.UsuarioCreador.Nombre} {item.UsuarioCreador.Apellido}")

              }
              else
              {
                <span>N/A</span>
              }
            </td>
            <td class="text-capitalize">
              @if (item.UsuarioModificador != null)
              {
                @($"{item.UsuarioModificador.Nombre} {item.UsuarioModificador.Apellido}")

              }
              else
              {
                <span>N/A</span>
              }
            </td>
          }
          <td>
            @if (item.Estado)
            {
              <span class="badge bg-success">Activa</span>
            }
            else
            {
              <span class="badge bg-danger">Anulada</span>
            }
          </td>
          <td class="text-nowrap">
            @if (item.Estado)
            {
              <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-outline-warning">
                Editar
              </a>
            }
            else
            {
              <button class="btn btn-sm btn-outline-secondary me-1" disabled>
                Editar
              </button>
            }

            <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-outline-info me-1">
              Detalles
            </a>

            @if (item.Estado)
            {
              <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                      data-bs-target="#anularModal-@item.Id">
                Anular
              </button>
            }
            else
            {
              <button class="btn btn-sm btn-outline-secondary" disabled>
                Anular
              </button>
            }
          </td>
          @if (item.Estado)
          {
            <div class="modal fade" id="anularModal-@item.Id" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog">
                <div class="modal-content">
                  <form asp-action="Delete" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@item.Id" />
                    <div class="modal-header">
                      <h5 class="modal-title">Anular venta</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <div class="alert alert-warning">
                          <strong>¿Seguro que deseas anular esta venta?</strong>
                          <br />
                          <ul class="mb-2">
                            <li><b>ID:</b> @item.Id</li>
                            <li><b>Fecha:</b> @item.Fecha.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</li>
                            <li><b>Total:</b> $@item.Total.ToString("N2")</li>
                            <li><b>Método de Pago:</b> @(item.MetodoPago?.Nombre ?? "N/A")</li>
                            <li><b>Detalle:</b>     <ul>
    @foreach (var det in item.Detalles)
    {
      <li>@det.Producto?.Nombre x @det.Cantidad</li>
    }
  </ul>
  </li>
                            </ul>
                          </div>
                          <label class="form-label">Motivo de anulacion</label>
                          <textarea name="motivoAnulacion" class="form-control" rows="3" required></textarea>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                          Cancelar
                        </button>
                        <button type="submit" class="btn btn-danger">
                          Confirmar anulacion
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            }

          </tr>
        }
      </tbody>
    </table>

<!-- Paginado -->
@if (totalPages > 1)
{
  <nav>
    <ul class="pagination justify-content-center">
      @if (currentPage > 1)
      {
        <li class="page-item">
          <a class="page-link" asp-action="Index" asp-route-page="@(currentPage - 1)"
             asp-route-metodoPagoId="@metodoPagoIdFiltro"
             asp-route-fechaMin="@fechaMin?.ToString("yyyy-MM-dd")"
             asp-route-fechaMax="@fechaMax?.ToString("yyyy-MM-dd")"
             asp-route-estado="@estadoFiltro"
             asp-route-usuarioCreadorId="@usuarioCreadorIdFiltro"
             asp-route-usuarioModificadorId="@usuarioModificadorIdFiltro">Anterior</a>
        </li>
      }

      @{
        int startPage = Math.Max(1, currentPage - 2);
        int endPage = Math.Min(totalPages, currentPage + 2);
      }

      @if (startPage > 1)
      {
        <li class="page-item">
          <a class="page-link" asp-action="Index" asp-route-page="1"
             asp-route-metodoPagoId="@metodoPagoIdFiltro"
             asp-route-fechaMin="@fechaMin?.ToString("yyyy-MM-dd")"
             asp-route-fechaMax="@fechaMax?.ToString("yyyy-MM-dd")"
             asp-route-estado="@estadoFiltro"
             asp-route-usuarioCreadorId="@usuarioCreadorIdFiltro"
             asp-route-usuarioModificadorId="@usuarioModificadorIdFiltro">1</a>
        </li>
        @if (startPage > 2)
        {
          <li class="page-item disabled">
            <span class="page-link">...</span>
          </li>
        }
      }

      @for (int i = startPage; i <= endPage; i++)
      {
        <li class="page-item @(i == currentPage ? "active" : "")">
          <a class="page-link" asp-action="Index" asp-route-page="@i"
             asp-route-metodoPagoId="@metodoPagoIdFiltro"
             asp-route-fechaMin="@fechaMin?.ToString("yyyy-MM-dd")"
             asp-route-fechaMax="@fechaMax?.ToString("yyyy-MM-dd")"
             asp-route-estado="@estadoFiltro"
             asp-route-usuarioCreadorId="@usuarioCreadorIdFiltro"
             asp-route-usuarioModificadorId="@usuarioModificadorIdFiltro">@i</a>
        </li>
      }

      @if (endPage < totalPages)
      {
        @if (endPage < totalPages - 1)
        {
          <li class="page-item disabled">
            <span class="page-link">...</span>
          </li>
        }
        <li class="page-item">
          <a class="page-link" asp-action="Index" asp-route-page="@totalPages"
             asp-route-metodoPagoId="@metodoPagoIdFiltro"
             asp-route-fechaMin="@fechaMin?.ToString("yyyy-MM-dd")"
             asp-route-fechaMax="@fechaMax?.ToString("yyyy-MM-dd")"
             asp-route-estado="@estadoFiltro"
             asp-route-usuarioCreadorId="@usuarioCreadorIdFiltro"
             asp-route-usuarioModificadorId="@usuarioModificadorIdFiltro">@totalPages</a>
        </li>
      }

      @if (currentPage < totalPages)
      {
        <li class="page-item">
          <a class="page-link" asp-action="Index" asp-route-page="@(currentPage + 1)"
             asp-route-metodoPagoId="@metodoPagoIdFiltro"
             asp-route-fechaMin="@fechaMin?.ToString("yyyy-MM-dd")"
             asp-route-fechaMax="@fechaMax?.ToString("yyyy-MM-dd")"
             asp-route-estado="@estadoFiltro"
             asp-route-usuarioCreadorId="@usuarioCreadorIdFiltro"
             asp-route-usuarioModificadorId="@usuarioModificadorIdFiltro">Siguiente</a>
        </li>
      }
    </ul>
  </nav>
}

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl)
        })
      });
    </script>